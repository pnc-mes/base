<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>原因代码管理</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" th:href="@{/static/layuimini/lib/layui-v2.5.5/css/layui.css}" media="all">
    <link rel="stylesheet" th:href="@{/static/layuimini/js/lay-module/formSelects-v4/formSelects-v4.css}" />
    <link rel="stylesheet" th:href="@{/static/layuimini/lib/font-awesome-4.7.0/css/font-awesome.min.css}" media="all">
    <link rel="stylesheet" th:href="@{/static/layuimini/css/public.css}" media="all">
    <style>

    </style>
</head>
<body>
<div class="layuimini-container">
    <div class="layuimini-main">
        <fieldset class="table-search-fieldset">
            <legend>搜索信息</legend>
            <div style="margin: 10px 10px 10px 10px">
                <form class="layui-form layui-form-pane" action="">
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label" style="width: 150px;">原因代码</label>
                            <div class="layui-input-inline">
                                <input type="text" name="reasonCode" autocomplete="off" class="layui-input">
                            </div>
                        </div>

                        <div class="layui-inline">
                            <button type="submit" class="layui-btn layui-btn-primary"  lay-submit lay-filter="data-search-btn"><i class="layui-icon"></i> 搜 索</button>
                        </div>
                    </div>
                </form>
            </div>
        </fieldset>

        <script type="text/html" id="toolbar">
            <div class="layui-btn-container">
                <button class="layui-btn layui-btn-normal layui-btn-sm data-add-btn" lay-event="add"> 添加 </button>
            </div>
        </script>

        <table class="layui-hide" id="currentTableId" lay-filter="currentTableFilter"></table>

        <script type="text/html" id="currentTableBar">
            <a class="layui-btn layui-btn-xs data-count-read" lay-event="read">查看</a>
            <a class="layui-btn layui-btn-normal layui-btn-xs data-count-edit" lay-event="edit">编辑</a>
            <a class="layui-btn layui-btn-xs layui-btn-danger data-count-delete" lay-event="delete">删除</a>
        </script>
    </div>
</div>

<!-- 子页面 -->
<div class="layui-fluid" id="badreasoninfo" style="display: none;">
    <div class="layui-card">
        <div class="layui-card-body" >
            <div class="layui-tab">
                <ul class="layui-tab-title">
                    <li class="layui-this">基础信息</li>
                    <li>其他信息</li>
                </ul>
                <div class="layui-tab-content">
                    <div class="layui-tab-item layui-show">
                        <form class="layui-form" action="" id="userinfoform" lay-filter="component-form-group" >
                            <div class="layui-tab-item layui-show">
                                <input type="hidden"id="_hidden" />
                                <div class="layui-form-item">
                                    <div class="layui-inline">
                                        <label class="layui-form-label" style="width: 150px;">原因代码</label>
                                        <div class="layui-input-inline">
                                            <input type="text" id="reasonCodes"  autocomplete="off" placeholder="请输入原因代码" class="layui-input">
                                        </div>
                                    </div>
                                    <div class="layui-inline">
                                        <label class="layui-form-label" style="width: 150px;">原因描述</label>
                                        <div class="layui-input-inline">
                                            <input type="text" id="reasonCodeDess"  autocomplete="off" placeholder="请输入原因描述" class="layui-input">
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <div class="layui-inline">
                                        <label class="layui-form-label" style="width: 150px;">原因类型</label>
                                        <div class="layui-input-inline">
                                            <select name="reasonType" lay-filter="" lay-search></select>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="layui-tab-item">

                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <label class="layui-form-label">创建人</label>
                                <div class="layui-input-inline">
                                    <input type="tel" name="creator" lay-verify="required" autocomplete="off" class="layui-input" readonly disabled>
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label">创建时间</label>
                                <div class="layui-input-inline">
                                    <input type="text" name="createTime" lay-verify="required" autocomplete="off" class="layui-input" readonly disabled>
                                </div>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <label class="layui-form-label">修改人</label>
                                <div class="layui-input-inline">
                                    <input type="tel" name="modifier" lay-verify="required" autocomplete="off" class="layui-input" readonly disabled>
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label">修改时间</label>
                                <div class="layui-input-inline">
                                    <input type="text" name="modifyTime" lay-verify="required" autocomplete="off" class="layui-input" readonly disabled>
                                </div>
                            </div>
                        </div>
                        <div class="layui-form-item layui-form-text">
                            <label class="layui-form-label">备注</label>
                            <div class="layui-input-block">
                                <textarea name="remark" placeholder="请输入内容" class="layui-textarea"></textarea>
                            </div>
                        </div>
                    </div>

                </div>
            </div>




        </div>
    </div>
</div>



<script th:src="@{/static/layuimini/lib/layui-v2.5.5/layui.js}" charset="utf-8"></script>
<script th:src="@{/static/layuimini/js/lay-config.js}" charset="utf-8"></script>
<script th:src="@{/static/layuimini/lib/jquery-3.4.1/jquery-3.4.1.min.js}" charset="utf-8"></script>
<script th:src="@{/static/utils/commons.js}" charset="utf-8"></script>
<script>
    layui.use(['form', 'table', 'laydate', 'element','formSelects',], function () {
        let $ = layui.jquery,
            form = layui.form,
            table = layui.table,
            formSelects=layui.formSelects,
            laydate = layui.laydate;

        //重新渲染表单函数
        function renderForm() {
            layui.use('form', function() {
                var form = layui.form;
                form.render();
            });
        }

        //页面首次加载
        load();

        //下拉框选择事件
        form.on('select(materialRds)', function(data){
            getAllWokerFool(data.value);
        });

        //toolbar监听事件
        table.on('toolbar(currentTableFilter)', function (obj) {
            var data=obj.data;

            if (obj.event === 'add') {  // 监听添加操作
                clear();
                let index = layer.open({
                    title: '添加原因代码',
                    type: 1,
                    shade: 0.2,
                    maxmin:true,
                    shadeClose: true,
                    area: ['50%', '70%'],
                    content:$("#badreasoninfo"),
                    btn: ['确认保存'],
                    yes: function (index, layero) {

                        save(index, 1);

                    }
                });
                $(window).on("resize", function () {
                    layer.full(index);
                });
            }
        });



        //表格中按钮事件
        table.on('tool(currentTableFilter)', function (obj) {
            let data = obj.data;
            if (obj.event === 'edit') {
                edit(data);
            } else if (obj.event === 'delete') {
                del(data);

            } else if(obj.event === 'read') {
                read(data);
            }else if(obj.event === 'xiada') {
                xiada(data);
            }
        });

        //监听搜索操作
        form.on('submit(data-search-btn)', function (data) {
            let field=[];
            if(data.field.reasonCode!=''){
                let   fields={
                    fieldName: "reaCode",
                    fieldOpt: "like",
                    fieldVal: data.field.reasonCode
                }
                field.push(fields);
            }
            field.push({
                fieldName: "CreateTime",
                fieldOpt: "Order BY",
                fieldVal: "DESC"
            });

            //执行搜索重载
            table.reload('currentTableId', {
                page: {
                    curr: 1
                }
                , where: {
                    fields: field
                }
            }, 'data');

            return false;
        });

        //查看
        function read(data) {
            let ReaRd = data.ReaRd;
            requests({url: "/Reason/GetRealInfo", contentType: "application/x-www-form-urlencoded", data: {"ExecType": "00",
                    "BusData": JSON.stringify({"ReaRd": ReaRd})
                }}, function (res) {
                let data = res.Data;

                clear();
                $("#_hidden").val(data.ReaRd);

                $("#reasonCodes").val(data.ReaCode);
                $("#reasonCodeDess").val(data.ReaDes);
                if(data.ReaTInfo==null){
                    $("select[name='reasonType']").val('');
                }else {
                    $("select[name='reasonType']").val(data.ReaTInfo.ReaTID);
                }
                renderForm()
                $("textarea[name='remark']").val(data.Remark);
                $("input[name='creator']").val(data.Creator);
                $("input[name='modifier']").val(data.LastModifyMan);
                $("input[name='modifyTime']").val(data.LastModifyTime);
                $("input[name='createTime']").val(data.CreateTime);

                let index = layer.open({
                    title: '查看原因代码',
                    type: 1,
                    shade: 0.2,
                    maxmin: true,
                    shadeClose: true,
                    area: ['50%', '70%'],
                    content: $("#badreasoninfo"),
                });
                $(window).on("resize", function () {
                    layer.full(index);
                });
            });

        }
        
        //编辑
        function edit(data) {
            let ReaRd = data.ReaRd;
            requests({url: "/Reason/GetRealInfo", contentType: "application/x-www-form-urlencoded", data: {"ExecType": "00",
                    "BusData": JSON.stringify({"ReaRd": ReaRd})
                }}, function (res) {
                let data = res.Data;

                clear();
                $("#_hidden").val(data.ReaRd);

                $("#reasonCodes").val(data.ReaCode);
                $("#reasonCodeDess").val(data.ReaDes);
                if(data.ReaTInfo==null){
                    $("select[name='reasonType']").val('');
                }else {
                    $("select[name='reasonType']").val(data.ReaTInfo.ReaTID);
                }
                renderForm()
                $("textarea[name='remark']").val(data.Remark);
                $("input[name='creator']").val(data.Creator);
                $("input[name='modifier']").val(data.LastModifyMan);
                $("input[name='modifyTime']").val(data.LastModifyTime);
                $("input[name='createTime']").val(data.CreateTime);


                let index = layer.open({
                    title: '修改原因代码',
                    type: 1,
                    shade: 0.2,
                    maxmin: true,
                    shadeClose: true,
                    area: ['50%', '70%'],
                    btn: ['确定', '取消'],
                    content: $("#badreasoninfo"),
                    yes: function(index, layero){
                        var ReaCode=$("#reasonCodes").val().trim();
                        var ReaDes=$("#reasonCodeDess").val().trim();
                        var Remark=$("textarea[name='remark']").val();

                        var ReaTID =$("select[name='reasonType']").val();

                        if(ReaCode==null){
                            layer.msg("原因代码不能为空");
                            return false;
                        }
                        if(ReaDes==null){
                            layer.msg("原因描述不能为空");
                            return false;
                        }
                        if(ReaTID==null){
                            layer.msg("原因类型不能为空");
                            return false;
                        }
                        var newData = {
                            ReaRd:$("#_hidden").val(),
                            ReaCode: ReaCode,
                            ReaDes: ReaDes,
                            Remark:Remark,
                            ReaTID:ReaTID
                        };

                        requests({url: "/Reason/SaveReaInfo", contentType: "application/x-www-form-urlencoded", data: {"ExecType": "02", "BusData": JSON.stringify(newData)
                            }}, function (res) {
                            layer.msg("保存成功", {icon: 1});
                            layer.close(index);
                            table.reload('currentTableId');
                        });
                }
                });
                $(window).on("resize", function () {
                    layer.full(index);
                });
            });




        }
        //删除
        function del(data) {
            var data = {
                "ReaRd": data.ReaRd
            };
            layer.confirm('真的删除行么', function (index) {
                requests({url: "/Reason/SaveReaInfo", contentType: "application/x-www-form-urlencoded", data: {"ExecType": "01",
                        "BusData": JSON.stringify(data)
                    }}, function (res) {
                    //obj.del();
                    layer.msg("删除成功", {icon: 1});
                    table.reload('currentTableId');
                });

                layer.close(index);
            });
        }
        
        //保存
        function save(index, type, shiftId) {
            if (type === 1) {

                var ReaCode=$("#reasonCodes").val().trim();
                var ReaDes=$("#reasonCodeDess").val().trim();
                var Remark=$("textarea[name='remark']").val();

                var ReaTID =$("select[name='reasonType']").val();

                if(ReaCode==null){
                    layer.msg("原因代码不能为空");
                    return false;
                }
                if(ReaDes==null){
                    layer.msg("原因描述不能为空");
                    return false;
                }
                if(ReaTID==null){
                    layer.msg("原因类型不能为空");
                    return false;
                }
                var newData = {
                    ReaCode: ReaCode,
                    ReaDes: ReaDes,
                    Remark:Remark,
                    ReaTID:ReaTID
                };

                requests({url: "/Reason/SaveReaInfo", contentType: "application/x-www-form-urlencoded", data: {"ExecType": "00", "BusData": JSON.stringify(newData)
                    }}, function (res) {
                    layer.msg("保存成功", {icon: 1});
                    layer.close(index);
                    table.reload('currentTableId');
                });
            }
        }
        //初始化表格数据
        function load() {
            table.render({
                elem: '#currentTableId',
                url: getBasePath() + "/Reason/GetAllReaNew",
                method: 'post',
                contentType: 'application/json',
                toolbar: '#toolbar',
                where: {
                    fields: [{
                        fieldName: "CreateTime",
                        fieldOpt: "Order BY",
                        fieldVal: "DESC"
                    }]
                },
                defaultToolbar: ['filter', 'exports', 'print'],
                cols: [
                    [
                        {field: 'ReaRd', title: 'ID', sort: true,hide:true},
                        {field: 'ReaCode', title: '原因代码'},
                        {field: 'ReaDes', title: '原因描述'},
                        {title: '操作', minWidth: 150, toolbar: '#currentTableBar', align: "center"}
                    ]
                ],
                request: {
                    pageName: 'current',
                    limitName: 'size'
                },
                parseData: function(res){
                    return {
                        code: res.status,
                        msg: res.body.msgDes,
                        count: res.body.data.total,
                        data: res.body.data.list
                    }
                },
                limits: [10, 15, 20, 25, 50, 100],
                limit: 10,
                page: true,
                skin: 'row '
            });
        }

        //清空
        function clear() {
            $("#reasonCodes").val("");
            $("#reasonCodeDess").val("");
            $("select[name='reasonType']").val('');
            renderForm();
            $("textarea[name='remark']").val("");
            $("input[name='creator']").val("");
            $("input[name='modifier']").val("");
            $("input[name='modifyTime']").val("");
            $("input[name='createTime']").val("");
        }

        //原因类型数据加载
       function getAllReasonType(){
           requests({url: "/Reason/GetReaTypeInfo", contentType: "application/x-www-form-urlencoded", data: {"ExecType": "00"
               }}, function (res) {
               var data=res.Data;
               var selectData='<option></option>';
               if(data.length>0){0
                   for(var i in data){
                       selectData+="<option value='"+data[i].ReaType+"'>"+data[i].ReaTDes+"</option>"
                   }
                   $("select[name='reasonType']").empty().html(selectData);
                   renderForm();
               }
           })
        }
        getAllReasonType();
    });




</script>
</body>
</html>
