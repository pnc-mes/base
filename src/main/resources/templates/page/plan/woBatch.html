<!--
* 公司名称：驭航信息技术（上海）有限公司
* 系统名称：PNC-MES管理系统
* 子系统名称：产品批次创建
* 创建人：pjf
* 创建时间：2020-09-15
* 修改人：
* 修改时间：
-->
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>产品批次创建</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" th:href="@{/static/layuimini/lib/layui-v2.5.5/css/layui.css}" media="all">
    <link rel="stylesheet" th:href="@{/static/layuimini/lib/font-awesome-4.7.0/css/font-awesome.min.css}" media="all">
    <link rel="stylesheet" th:href="@{/static/layuimini/css/public.css}" media="all">
    <style>
        .inputRead {
            background: #f2f2f2;
        }
        .dPanel{
            margin: 10px 5px;
        }
        .layui-input-block{
            width: 260px;
        }
    </style>
</head>
<body>
<div class="layuimini-container">
    <div class="layuimini-main">
        <script type="text/html" id="currentTableBar">
            <a class="layui-btn layui-btn-xs layui-btn-danger data-count-delete" lay-event="delete">删除</a>
        </script>

        <div class="layui-tab layui-tab-brief" lay-filter="docDemoTabBrief">
            <ul class="layui-tab-title">
                <li class="layui-this">基本信息</li>
                <li>关联批次</li>
            </ul>
            <div class="layui-form layui-tab-content">
                <div class="layui-tab-item layui-show">
                    <div class="layui-row">
                        <div class="dPanel">
                            <div class="layui-inline">
                                <label class="layui-form-label required">工单号</label>
                                <div class="layui-input-block">
                                    <div id="woCode" class="xm-select-demo"></div>
                                </div>
                            </div>

                            <div class="layui-inline">
                                <label class="layui-form-label required">数量</label>
                                <div class="layui-input-block">
                                    <input type="text" id="woNum" name="woNum" class="layui-input inputRead" readonly />
                                </div>
                            </div>

                            <div class="layui-inline">
                                <label class="layui-form-label">未创数量</label>
                                <div class="layui-input-block">
                                    <input type="text" id="unCBatNum" name="unCBatNum" class="layui-input inputRead" readonly />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="layui-row">
                        <div class="dPanel">
                            <div class="layui-inline">
                                <label class="layui-form-label required">产品</label>
                                <div class="layui-input-block">
                                    <input type="text" id="maCode" name="maCode" class="layui-input inputRead" readonly />
                                </div>
                            </div>

                            <div class="layui-inline">
                                <label class="layui-form-label required">工艺流程</label>
                                <div class="layui-input-block">
                                    <input type="text" id="wf" name="wf" class="layui-input inputRead" readonly />
                                </div>
                            </div>

                            <div class="layui-inline">
                                <label class="layui-form-label">开始工序</label>
                                <div class="layui-input-block">
                                    <div id="startSpec" class="xm-select-demo"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="layui-row">
                        <div class="dPanel">
                            <div class="layui-inline">
                                <label class="layui-form-label required">拆成</label>
                                <div class="layui-input-block">
                                    <input type="text" id="count" name="count" class="layui-input" />
                                </div>
                            </div>

                            <div class="layui-inline">
                                <label class="layui-form-label required">每批</label>
                                <div class="layui-input-block">
                                    <input type="text" id="num" name="num" class="layui-input" />
                                </div>
                            </div>

                            <div class="layui-inline" style="display: none;">
                                <label class="layui-form-label">开始时间</label>
                                <div class="layui-input-block">
                                    <input type="text" id="startTime" name="startTime" lay-verify="required" lay-reqtext="开始时间不能为空" value="" class="layui-input">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="layui-row">
                        <div class="dPanel">
                            <div class="layui-inline">
                                <label class="layui-form-label">打印模板</label>
                                <div class="layui-input-block">
                                    <div id="printT" class="xm-select-demo"></div>
                                </div>
                            </div>

                            <div class="layui-inline">
                                <label class="layui-form-label">打印机</label>
                                <div class="layui-input-block">
                                    <div id="print" class="xm-select-demo"></div>
                                </div>
                            </div>

                            <div class="layui-inline" style="display: none;">
                                <label class="layui-form-label">结束时间</label>
                                <div class="layui-input-block">
                                    <input type="text" id="endTime" name="endTime" lay-verify="required" lay-reqtext="结束时间不能为空" value="" class="layui-input">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="layui-row">
                        <div class="dPanel">
                            <div class="layui-form-item">
                                <div class="layui-input-block">
                                    <input id="isABatch" type="checkbox" lay-filter="checkbox" title="自动生成批次" checked>
                                    <button class="layui-btn" lay-filter="formDemo" id="save">保存</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="layui-tab-item">
                    <!-- 物流信息 -->
                    <div class="dPanel">
                        <table class="layui-hide" id="relatedTable"></table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="layuimini-container" id="content" style="display: none; margin-top: 20px;">
    <div class="layuimini-main">
        <div>
            <div class="layui-row">
                <div class="dPanel">
                    <div class="layui-inline">
                        <input type="text" id="batch" name="batch" class="layui-input" placeholder="批次号" />
                    </div>

                    <div class="layui-inline">
                        <input type="text" id="sNum" name="sNum" class="layui-input" placeholder="数量" />
                    </div>

                    <button class="layui-btn layui-btn-primary" id="add">新增</button>
                </div>
            </div>

            <table class="layui-hide" id="currentTableId" lay-filter="currentTableFilter"></table>
        </div>
    </div>
</div>

<script th:src="@{/static/layuimini/lib/layui-v2.5.5/layui.js}" charset="utf-8"></script>
<script th:src="@{/static/layuimini/js/lay-config.js}" charset="utf-8"></script>
<script th:src="@{/static/layuimini/lib/jquery-3.4.1/jquery-3.4.1.min.js}" charset="utf-8"></script>
<script th:src="@{/static/utils/commons.js}" charset="utf-8"></script>
<script>
    layui.use(['form','element','table','xmSelect', 'laydate'], function () {
        let $ = layui.jquery,
            form = layui.form,
            table = layui.table,
            xmSelect = layui.xmSelect,
            laydate = layui.laydate;

        //加载时间
        laydate.render({
            elem: '#startTime'
        });
        laydate.render({
            elem: '#endTime'
        });

        //页面首次加载
        load();
        loadRelated();

        //单选通用设置
        let radioSetting = {
            radio: true
            ,clickClose: true
            ,theme: {
                color: '#5FB878',
            },model: {
                icon: 'hidden',
                label: {
                    type: 'text'
                }
            },toolbar: {
                show: true,
            },
            filterable: true
        }

        //加载工序
        let startSpecS = xmSelect.render({
            el: '#startSpec'
            ,radio: true
            ,clickClose: true
            ,filterable: true
            ,theme: {
                color: '#5FB878',
            }
            ,model: {
                icon: 'hidden',
                label: {
                    type: 'text'
                }
            }
            ,prop: {
                name: 'SpecName',
                value: 'SpecVerRd',
            }
            ,data: []
        });

        //加载工单信息
        let woS = xmSelect.render({
            el: '#woCode'
            ,...radioSetting
            ,prop: {
                name: 'woCode',
                value: 'woRd',
            }
            ,paging: true
            ,pageRemote: true
            ,//数据处理
            remoteMethod: function(val, cb, show, pageIndex){
                //val: 搜索框的内容, 不开启搜索默认为空, cb: 回调函数, show: 当前下拉框是否展开, pageIndex: 当前第几页
                requests({url: "/WO/GetAllNewWOInfo", data: JSON.stringify({fields: [{
                    fieldName: "ruid",
                    fieldOpt: "Order BY",
                    fieldVal: "desc"
                },{
                    fieldName: "woCode",
                    fieldOpt: "like",
                    fieldVal: val
                }], size: 10, current: pageIndex })}, function (res) {
                    cb(res.data.list, res.data.totalPage);
                });
            }
            ,on: function (data) {
                //查询工单明细信息
                if(data.isAdd && data.change.length > 0){
                    let woRd = data.change[0].woRd;
                    loadWo(woRd);
                }
            }
        });

        //加载打印模板信息
        let ptS = xmSelect.render({
            el: '#printT'
            ,...radioSetting
            ,prop: {
                name: 'PtName',
                value: 'PtRd',
            }
            ,data: []
        });
        requests({url: "/PrintT/GetAllPtNew"}, function (res) {
            ptS.update({
                data: res.data.list,
                autoRow: true
            })
        });

        //加载打印机信息
        let pS = xmSelect.render({
            el: '#print'
            ,...radioSetting
            ,prop: {
                name: 'PrName',
                value: 'PrRd',
            }
            ,data: []
        });
        requests({url: "/Printer/GetAllPrNew"}, function (res) {
            pS.update({
                data: res.data.list,
                autoRow: true
            })
        });

        //checkbox触发事件
        form.on("checkbox(checkbox)", function (data) {
            if(data.elem.checked){
                $("#content").hide();
                $("#count").removeClass("inputRead");
                $("#num").removeClass("inputRead");
                $("#count").prop("disabled", false);
                $("#num").prop("disabled", false);
            }else{
                $("#content").show();
                $("#count").addClass("inputRead");
                $("#count").prop("disabled", true);
                $("#num").addClass("inputRead");
                $("#num").prop("disabled", true);
            }
        });

        //手动添加批次
        let dList = [];
        $("#add").click(function () {
            let batch = $("#batch").val().trim();
            let num = $("#sNum").val();
            if(batch === ''){
                layer.msg("批次号不能为空", {icon: 2});
                return;
            }
            if(Number(num) <= 0){
                layer.msg("数量不能小于等于零", {icon: 2});
                return;
            }

            if(dList.length != dList.filter(o => o.Batch !== batch).length){
                layer.msg("不能添加相同批次", {icon: 2});
                return;
            }

            dList.push({Batch: batch, Num: num});

            $("#batch").val("");

            table.reload('currentTableId', {
                data: dList
            })
        });

        //表格中按钮事件
        table.on('tool(currentTableFilter)', function (obj) {
            if (obj.event === 'delete') {
                layer.confirm('真的删除行么', function (index) {
                    dList = dList.filter(o => o.Batch !== obj.data.Batch);
                    table.reload('currentTableId', {
                        data: dList
                    })
                    layer.close(index);
                });
            }
        });

        //保存
        $("#save").click(function() {
            let data = checkParams();

            if(data == undefined){
                return;
            }

            requests({url: "/Batch/SaveBatchInfo", contentType: "application/x-www-form-urlencoded", data: {"ExecType": "00",
                    "BusData": JSON.stringify(data)
            }}, function (res) {
                layer.msg("新增成功", {icon: 1});
                loadWo(data.WoRd);
                clear();
            });
        });

        //加载工单详情
        function loadWo(id){
            requests({url: "/WO/GetWOInfo", contentType: "application/x-www-form-urlencoded", data: {"ExecType": "00",
                    "BusData": JSON.stringify({"WoRd": id})
                }}, function (res) {
                let data = res.Data;

                $("#woNum").val(data.Num);
                $("#unCBatNum").val(data.UnCBatNum);
                $("#maCode").val(data.MaInfo.MaCode);
                $("#count").val(1);
                $("#num").val(data.UnCBatNum);

                if(data.WFInfo != undefined){
                    $("#wf").val(data.WFInfo.WFName);
                    startSpecS.update({
                        data: data.WFInfo.SpecInfo,
                        autoRow: true,
                        initValue: data.WFInfo.SpecInfo.length > 0 ? [data.WFInfo.SpecInfo[0]] : [],
                    });
                }

                //查询关联批次
                requests({url: "/WO/GetAllWOBInfo", contentType: "application/x-www-form-urlencoded", data: {"ExecType": "00",
                        "BusData": JSON.stringify({"WoRd": id})
                    }}, function (res) {
                    let data = res.Data;

                    table.reload('relatedTable', {
                        data: data
                    })
                });
            });
        }

        //初始化表格数据
        function load() {
            table.render({
                elem: '#currentTableId',
                cols: [
                    [
                        {field: 'Batch', title: '批次号' },
                        {field: 'Num', title: '数量' },
                        {title: '操作', minWidth: 150, toolbar: '#currentTableBar', align: "center"}
                    ]
                ],
                data: [],
                limits: [10, 15, 20, 25, 50, 100],
                limit: 10,
                page: true,
                skin: 'row '
            });
        }

        //初始化关联批次
        function loadRelated() {
            table.render({
                elem: '#relatedTable',
                defaultToolbar: ['filter', 'exports', 'print'],
                cols: [
                    [
                        {field: 'WoBRd', title: 'ID', hide: true},
                        {field: 'Batch', title: '批次号' },
                        {field: 'CanNum', title: '生产数量' },
                        {field: 'UnitName', title: '单位' },
                        {field: 'JFDate', title: '计划完成时间' },
                        {field: 'SFDate', title: '实际完成时间' },
                        {field: 'MaDes', title: '状态' },
                    ]
                ],
                data: [],
                limits: [10, 15, 20, 25, 50, 100],
                limit: 10,
                page: true,
                skin: 'row '
            });
        }

        //检查
        function checkParams(){
            //工单RD
            let woRd = woS.getValue("valueStr");
            if(woRd == undefined || woRd == ""){
                layer.msg("工单不能为空", {icon: 2});
                return;
            }

            //SpecVerRd
            let specVerRd = startSpecS.getValue("valueStr");
            if(specVerRd == undefined || specVerRd == ""){
                layer.msg("开始工序不能为空", {icon: 2});
                return;
            }

            //allNum
            let allNum = $("#count").val();
            if(allNum == undefined || allNum == "" || isNaN(allNum)){
                layer.msg("拆批数量填写有误", {icon: 2});
                return;
            }

            //Num
            let num = $("#num").val();
            if(num == undefined || num == "" || isNaN(num)){
                layer.msg("批次数量填写有误", {icon: 2});
                return;
            }

            //日期检验
            let startDate = $("#startTime").val();
            let finishDate = $("#endTime").val();
            if(((new Date(startDate.replace(/-/g,"\/"))) > (new Date(finishDate.replace(/-/g,"\/"))))){
                layer.msg("起始时间不能大于结束时间", {icon: 2});
                return;
            }

            //是否自动创批
            let bInfo = [];
            let isABatch = "00";
            if(!$("#isABatch").prop("checked")){
                isABatch = "01";

                bInfo = dList;
                let set = new Set();
                for(let i=0; i<bInfo.length; i++){
                    let obj = bInfo[i];
                    if(obj.Batch.trim() == "" || obj.Num.trim() == ""){
                        layer.msg("批次或数量不能为空", {icon: 2});
                        return;
                    }
                    set.add(obj.Batch.trim());
                }
                if(set.size < bInfo.length){
                    layer.msg("请勿添加重复批次", {icon: 2});
                    return;
                }
                allNum = bInfo.length;
            }

            //PrintTRd
            let printTRd = ptS.getValue("valueStr");

            //PrintRd
            let printRd = pS.getValue("valueStr");

            let data = {
                WoRd: woRd,
                SpecVerRd: specVerRd,
                SplitBCount: allNum,
                BCount: num,
                IsABatch: isABatch,
                BInfo: bInfo,
                PrintTRd: printTRd,
                PrintRd: printRd,
                JStartDate: startDate,
                JFinishDate: finishDate,
                WoSource: "01",
                IsPrint: "00",
                IsPrintPack: "01"
            };

            return data;
        }

        //清空
        function clear() {
            dList = [];
            table.reload('currentTableId', {
                data: dList
            });
            $("#batch").val("");
            $("#sNum").val("");
        }
    });
</script>
</body>
</html>
